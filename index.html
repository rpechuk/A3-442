<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Scrolling Nav - Start Bootstrap Template</title>
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <!-- Scrubber theme -->
        <link href="css/scrubber.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
            <div class="container px-4">
                <a class="navbar-brand" href="#page-top">A3 - Flights</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#visualization">Visualization</a></li>
                        <li class="nav-item"><a class="nav-link" href="#writeup">Write Up</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Visualization section-->
        <section id="visualization">
            <div class="container px-4">
                <div class="row gx-4 justify-content-center">
                    <div class="col-lg-8">
                        <h2>Replace Me with a title for the visualization</h2>
                        <p class="lead">Add some further description here if you see fit:</p>
                        <div id="scrubber">
                            <p class="lead" id="scrubber-text">Year: <span id="year">0</span></p>
                        </div>
                        <div id="graph"></div>
                        <div id="tooltip" class="hidden">
                            <p><strong>Flights to <span id="airport">XYZ</span> had</strong></p>
                            <p><span id="flights">0</span> Passengers</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Writeup section-->
        <section class="bg-light" id="writeup">
            <div class="container px-4">
                <div class="row gx-4 justify-content-center">
                    <div class="col-lg-8">
                        <h2>Write Up:</h2>
                        <p class="lead">We made the decisions because of .....</p>
                    </div>
                </div>
            </div>
        </section>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <!-- Scrubber theme JS-->
        <script src="js/scrubber.js"></script>
        <!-- D3 JS -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script type="module">
            // Constants:
            const w = 800;
            const h = 500;
            const padding = 40;

            const topX = 15;
            const stepSize = 1;

            const colorStart = 80;
            const colorEnd = 225;

            // Data import:
            const dt = await aq.loadCSV('/assets/International_Report_Passengers.csv');
            // Get extents:
            const years = d3.extent(dt.objects(), d => d.Year);
            // Data Transformations:
            var datasetAll = [];
            for(var i = 0; i <= years[1] - years[0]; i++) {
                var year = years[0] + i;
                var dtNew = dt.filter(aq.escape(d => d.Year == year))
                    .groupby("Destination")
                    .rollup({
                        total_passengers: d => op.sum(d.Passengers),
                        count: aq.op.count()
                    })
                    .derive({
                        Year: year
                    })
                    .orderby(aq.desc('total_passengers'))
                    .slice(0, topX);
                    datasetAll = datasetAll.concat(dtNew.objects());
            }
            console.log(datasetAll);

            // Create scrubber:
            var scrubber = new ScrubberView();
            // Change settings
            scrubber.min(years[0]).max(years[1]).step(stepSize).value(scrubber.min());
            d3.select("#scrubber").select("#year").text(scrubber.value());
            // Add to DOM
            document.getElementById("scrubber").appendChild(scrubber.elt);

            // Get starting dataset and corresponding information:
            var dataset = datasetAll.filter(d => d.Year === years[0]);
            var destinations = [...new Set(dataset.map(d => d.Destination))]
            // Create Scales:
            var yScale = d3.scaleBand()
                            .domain(destinations)
                            .rangeRound([padding, h - padding])
                            .paddingInner(0.05);
            var xScale = d3.scaleLinear()
                            .domain([0, d3.max(dataset, d => d.total_passengers)])
                            .range([padding, w - padding]);
            var colorScale = d3.scaleLinear()
                            .domain([0, d3.max(dataset, d => d.total_passengers)])
                            .range([colorStart, colorEnd]);
            // Easier to use color scale
            var color = (scale, value) => {
                return "rgb( 20, " + scale(value) + ", " + scale(value) + ")";
            }

            // Create SVG element
            var svg = d3.select("#graph")
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h);
            // Create bars
            svg.selectAll("rect")
                .data(dataset)
                .join("rect")
                .attr("x", function(d) {
                        return padding;
                })
                .attr("y", function(d) {
                        return yScale(d.Destination);
                })
                .attr("width", function(d) {
                        return xScale(d.total_passengers) - padding;
                })
                .attr("height", yScale.bandwidth())
                .attr("fill", function(d) {
                        return color(colorScale, d.total_passengers);
                })
                .on("mouseover", function(d) {
                        // Get this bar's x/y values, then augment for the tooltip
                        var yPosition = parseFloat(d3.select(this).attr("y")) + (6 * yScale.bandwidth());
                        var xPosition = parseFloat(d3.select(this).attr("x")) + parseFloat(d3.select(this).attr("width")) + w / 4;

                        // Update the tooltip position
                        var tooltip = d3.select("#tooltip")
                            .style("left", xPosition + "px")
                            .style("top", yPosition + "px");

                        // Update the tooltip text                
                        tooltip.select("#airport")
                            .text(d.srcElement.__data__.Destination);
                        tooltip.select("#flights")
                            .text(d.srcElement.__data__.total_passengers.toLocaleString("en-US"));

                        //Show the tooltip
                        d3.select("#tooltip").classed("hidden", false);

                })
                .on("mouseout", function() {
                        //Hide the tooltip
                        d3.select("#tooltip").classed("hidden", true);
                });
            // Create axis
            svg.append("g")
                    .attr("id", "xAxis")
                    .attr("transform", "translate(0," + (h - padding) + ")")
                    .call(d3.axisBottom().scale(xScale));

            svg.append("g")
                .attr("id", "yAxis")
                .attr("transform", "translate(" + padding + ",0)")
                .call(d3.axisLeft().scale(yScale));
            // Create labels
            const yearLabel = svg.append('text')
                .attr('class', 'year')
                .attr('x', w * 0.7)
                .attr('y', h - padding - 20)
                .attr('fill', '#ccc')
                .attr('font-family', 'Helvetica Neue, Arial')
                .attr('font-weight', 500)
                .attr('font-size', 80)
                .text(years[0]);
  
            // Add interaction:
            scrubber.onScrubEnd = function (value) {
                // Update Scrubber text
                d3.select("#scrubber").select("#year").text(value);
                // Update dataset
                dataset = datasetAll.filter(d => d.Year === value);
                // Update extent
                destinations = [...new Set(dataset.map(d => d.Destination))]
                // Update scales
                xScale = d3.scaleLinear()
                        .domain([0, d3.max(dataset, d => d.total_passengers)])
                        .range([padding, w - padding]);
                yScale = d3.scaleBand()
                        .domain(destinations)
                        .rangeRound([padding, h - padding])
                        .paddingInner(0.05);

                colorScale = d3.scaleLinear()
                    .domain([0, d3.max(dataset, d => d.total_passengers)])
                    .range([colorStart, colorEnd]);        
                // Update bars
                svg.selectAll("rect")
                    .data(dataset)
                    .transition()
                        .duration(1000)
                        .attr("y", function(d) {
                                return yScale(d.Destination);
                        })
                        .attr("width", function(d) {
                                return xScale(d.total_passengers) - padding;
                        })
                        .attr("fill", function(d) {
                                return color(colorScale, d.total_passengers);
                        })
                // Update axis
                svg.select("#xAxis")
                    .transition()
                    .duration(1000)
                    .call(d3.axisBottom().scale(xScale));
                svg.select("#yAxis")
                    .transition()
                    .duration(1000)
                    .call(d3.axisLeft().scale(yScale));
                // Update label
                yearLabel.transition().text(value);
            }

        </script>
        <!-- Arquero import -->
        <script src="https://cdn.jsdelivr.net/npm/arquero@latest"></script>
    </body>
</html>